import type { HandsJson } from "./schema.js"
import { registry } from "../sources/index.js"

/**
 * Generate wrangler.toml content from hands.json
 */
export function generateWranglerToml(config: HandsJson, options: { dev?: boolean } = {}): string {
  const lines: string[] = [
    "# Auto-generated by `hands build` - do not edit",
    `# Source: hands.json`,
    "",
    `name = "${config.name}"`,
    `main = "worker.ts"`,
    `compatibility_date = "2024-01-01"`,
    `compatibility_flags = ["nodejs_compat"]`,
    "",
  ]

  // Collect cron schedules from enabled sources
  const crons: string[] = []
  for (const [sourceName, sourceConfig] of Object.entries(config.sources)) {
    if (!sourceConfig.enabled) continue

    // Get schedule from config or fall back to registry default
    let schedule = sourceConfig.schedule
    if (!schedule) {
      const registryItem = registry.items.find((i) => i.name === sourceName)
      schedule = registryItem?.schedule ?? "0 * * * *" // Default: hourly
    }

    crons.push(schedule)
  }

  // Add triggers if we have crons
  if (crons.length > 0) {
    // Deduplicate crons (multiple sources might share same schedule)
    const uniqueCrons = [...new Set(crons)]
    lines.push("[triggers]")
    lines.push(`crons = [${uniqueCrons.map((c) => `"${c}"`).join(", ")}]`)
    lines.push("")
  }

  // Add vars
  lines.push("[vars]")
  lines.push(`ENVIRONMENT = "${options.dev ? "development" : "production"}"`)
  lines.push("")

  // Document required secrets
  const secretEntries = Object.entries(config.secrets)
  if (secretEntries.length > 0) {
    lines.push("# Required secrets (set via wrangler secret put)")
    for (const [name, secretConfig] of secretEntries) {
      const desc = secretConfig.description ? ` - ${secretConfig.description}` : ""
      const req = secretConfig.required ? " (required)" : " (optional)"
      lines.push(`# ${name}${req}${desc}`)
    }
    lines.push("")
  }

  // Also document secrets required by sources
  const sourceSecrets = new Set<string>()
  for (const [sourceName, sourceConfig] of Object.entries(config.sources)) {
    if (!sourceConfig.enabled) continue
    const registryItem = registry.items.find((i) => i.name === sourceName)
    if (registryItem?.secrets) {
      for (const secret of registryItem.secrets) {
        sourceSecrets.add(secret)
      }
    }
  }

  if (sourceSecrets.size > 0) {
    lines.push("# Secrets required by sources:")
    for (const secret of sourceSecrets) {
      if (!config.secrets[secret]) {
        lines.push(`# ${secret}`)
      }
    }
    lines.push("")
  }

  // Dev settings
  if (options.dev) {
    lines.push("[dev]")
    lines.push("port = 8787")
    lines.push('local_protocol = "http"')
    lines.push("")
  }

  return lines.join("\n")
}
