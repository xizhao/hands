/**
 * Build system for workbooks
 *
 * Transforms hands.json -> .hands/wrangler.toml + .hands/worker.ts
 */

import { existsSync, mkdirSync, readFileSync, writeFileSync } from "fs";
import { join } from "path";

export interface BuildOptions {
  dev?: boolean;
}

export interface BuildResult {
  success: boolean;
  outputDir: string;
  files: string[];
  errors: string[];
}

interface HandsConfig {
  name?: string;
  version?: string;
  database?: {
    migrations?: string;
  };
  blocks?: Record<string, { title: string; file: string }>;
  sources?: Record<string, unknown>;
  secrets?: Record<string, unknown>;
  build?: {
    outDir?: string;
  };
}

/**
 * Build a workbook from hands.json
 */
export async function build(
  workbookDir: string,
  options: BuildOptions = {}
): Promise<BuildResult> {
  const errors: string[] = [];
  const files: string[] = [];
  const outputDir = join(workbookDir, ".hands");

  try {
    // Read hands.json
    const handsJsonPath = join(workbookDir, "hands.json");
    if (!existsSync(handsJsonPath)) {
      return {
        success: false,
        outputDir,
        files: [],
        errors: [`No hands.json found in ${workbookDir}`],
      };
    }

    const handsConfig: HandsConfig = JSON.parse(
      readFileSync(handsJsonPath, "utf-8")
    );

    // Ensure output directory exists
    if (!existsSync(outputDir)) {
      mkdirSync(outputDir, { recursive: true });
    }

    // Generate wrangler.toml
    const wranglerToml = generateWranglerToml(handsConfig, options);
    const wranglerPath = join(outputDir, "wrangler.toml");
    writeFileSync(wranglerPath, wranglerToml);
    files.push("wrangler.toml");

    // Generate worker.ts entry point
    const workerTs = generateWorkerEntry(workbookDir, handsConfig);
    const workerPath = join(outputDir, "worker.ts");
    writeFileSync(workerPath, workerTs);
    files.push("worker.ts");

    return {
      success: true,
      outputDir,
      files,
      errors: [],
    };
  } catch (error) {
    return {
      success: false,
      outputDir,
      files,
      errors: [error instanceof Error ? error.message : String(error)],
    };
  }
}

function generateWranglerToml(config: HandsConfig, options: BuildOptions): string {
  const name = config.name || "workbook";
  const isDev = options.dev ?? false;

  return `# Generated by hands build system
name = "${name}"
compatibility_date = "2024-01-01"
main = "worker.ts"

[vars]
# DATABASE_URL is set at runtime by the dev server

${isDev ? `
[dev]
local_protocol = "http"
` : ""}
`;
}

function generateWorkerEntry(workbookDir: string, config: HandsConfig): string {
  // Check if there's a src/index.tsx or src/index.ts
  const srcIndexTsx = join(workbookDir, "src", "index.tsx");
  const srcIndexTs = join(workbookDir, "src", "index.ts");

  let entryImport = "";
  if (existsSync(srcIndexTsx)) {
    entryImport = `export { default } from "../src/index.tsx";`;
  } else if (existsSync(srcIndexTs)) {
    entryImport = `export { default } from "../src/index.ts";`;
  } else {
    // Generate a minimal worker if no src/index exists
    entryImport = `
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => c.json({ status: "ok", name: "${config.name || "workbook"}" }));
app.get("/health", (c) => c.json({ healthy: true }));

export default app;
`;
  }

  return `// Generated by hands build system
// Do not edit directly - changes will be overwritten

${entryImport}
`;
}
