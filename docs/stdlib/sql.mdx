---
title: SQL Client
description: "Database query interface"
---

# SQL Client

The SQL client provides a safe, ergonomic way to query your PostgreSQL database.

## Import

```typescript
import { sql } from "@hands/stdlib";
```

Or get it from handler context:

```typescript
export const handler = monitor(async (ctx) => {
  const result = await ctx.sql`SELECT * FROM users`;
});
```

## Tagged Template Queries

Use template literals for safe, parameterized queries:

```typescript
const userId = 123;
const users = await sql`SELECT * FROM users WHERE id = ${userId}`;
```

Parameters are automatically escaped, preventing SQL injection.

## Basic Queries

### SELECT

```typescript
// All rows
const users = await sql`SELECT * FROM users`;

// With conditions
const active = await sql`SELECT * FROM users WHERE active = true`;

// With parameters
const user = await sql`SELECT * FROM users WHERE id = ${id}`;
```

### INSERT

```typescript
const [newUser] = await sql`
  INSERT INTO users (name, email)
  VALUES (${name}, ${email})
  RETURNING *
`;
```

### UPDATE

```typescript
await sql`
  UPDATE users
  SET name = ${newName}
  WHERE id = ${id}
`;
```

### DELETE

```typescript
await sql`DELETE FROM users WHERE id = ${id}`;
```

## Bulk Operations

### Insert Multiple Rows

```typescript
const users = [
  { name: "Alice", email: "alice@example.com" },
  { name: "Bob", email: "bob@example.com" }
];

await sql`INSERT INTO users ${sql(users)}`;
```

### Dynamic Values

```typescript
const columns = ["name", "email"];
const values = ["Alice", "alice@example.com"];

await sql`
  INSERT INTO users ${sql(columns)}
  VALUES ${sql(values)}
`;
```

## Unsafe Queries

For dynamic SQL that can't use parameters:

```typescript
const tableName = "users";  // ⚠️ Must be trusted
const result = await sql.unsafe(`SELECT * FROM ${tableName}`);
```

<Warning>
Only use `unsafe` with trusted input. Never pass user input directly.
</Warning>

## Transactions

```typescript
await sql.begin(async (tx) => {
  await tx`UPDATE accounts SET balance = balance - ${amount} WHERE id = ${from}`;
  await tx`UPDATE accounts SET balance = balance + ${amount} WHERE id = ${to}`;
});
```

If any query fails, all changes are rolled back.

## Return Types

Queries return arrays:

```typescript
const users = await sql`SELECT * FROM users`;
// users: Array<{ id: number, name: string, ... }>

const [user] = await sql`SELECT * FROM users WHERE id = ${id}`;
// user: { id: number, name: string, ... } | undefined
```

## Aggregates

```typescript
const [{ count }] = await sql`SELECT COUNT(*) FROM users`;
// count: string (PostgreSQL returns BIGINT as string)

const [{ total }] = await sql`SELECT SUM(amount) as total FROM orders`;
```

## JSON Columns

```typescript
// Insert JSON
await sql`
  INSERT INTO events (type, data)
  VALUES (${type}, ${JSON.stringify(data)})
`;

// Query JSON
const events = await sql`
  SELECT data->>'userId' as user_id
  FROM events
  WHERE data->>'type' = ${eventType}
`;
```

## Common Patterns

### Upsert

```typescript
await sql`
  INSERT INTO users (id, name, email)
  VALUES (${id}, ${name}, ${email})
  ON CONFLICT (id) DO UPDATE
  SET name = EXCLUDED.name,
      email = EXCLUDED.email
`;
```

### Pagination

```typescript
const page = 1;
const limit = 20;
const offset = (page - 1) * limit;

const users = await sql`
  SELECT * FROM users
  ORDER BY created_at DESC
  LIMIT ${limit} OFFSET ${offset}
`;
```

### Search

```typescript
const search = "%smith%";
const users = await sql`
  SELECT * FROM users
  WHERE LOWER(name) LIKE ${search.toLowerCase()}
`;
```

## Error Handling

```typescript
try {
  await sql`INSERT INTO users (email) VALUES (${email})`;
} catch (error) {
  if (error.code === "23505") {
    // Unique violation
    throw new Error("Email already exists");
  }
  throw error;
}
```

## Connection Info

In development:

```
Host: localhost
Port: 5433
Database: hands_db
User: hands
Password: hands
```

Connection string:
```
postgresql://hands:hands@localhost:5433/hands_db
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Monitors" icon="clock" href="/stdlib/monitor">
    Use SQL in scheduled jobs
  </Card>
  <Card title="Dashboards" icon="gauge" href="/stdlib/dashboard">
    Use SQL in web pages
  </Card>
</CardGroup>
