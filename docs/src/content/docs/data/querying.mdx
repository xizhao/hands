---
title: Querying Data
description: Write SQL queries to analyze your data
---

Hands uses PostgreSQL as its query engine, giving you access to full SQL capabilities.

## Basic queries

Use the `sql` template tag from the stdlib:

```typescript
import { sql } from '@hands/stdlib';

// Simple select
const users = await sql`SELECT * FROM users`;

// With conditions
const active = await sql`
  SELECT * FROM users
  WHERE status = 'active'
  ORDER BY created_at DESC
`;

// Aggregations
const stats = await sql`
  SELECT
    status,
    COUNT(*) as count,
    AVG(age) as avg_age
  FROM users
  GROUP BY status
`;
```

## Parameters

Use template interpolation for safe parameterized queries:

```typescript
// Safe from SQL injection
const userId = 123;
const user = await sql`
  SELECT * FROM users WHERE id = ${userId}
`;

// Multiple parameters
const results = await sql`
  SELECT * FROM orders
  WHERE user_id = ${userId}
    AND status = ${status}
    AND created_at > ${startDate}
`;
```

## Joins

```typescript
const ordersWithUsers = await sql`
  SELECT
    o.id,
    o.total,
    u.name as customer_name
  FROM orders o
  JOIN users u ON o.user_id = u.id
  WHERE o.status = 'completed'
`;
```

## Window functions

PostgreSQL window functions are fully supported:

```typescript
const ranked = await sql`
  SELECT
    name,
    revenue,
    RANK() OVER (ORDER BY revenue DESC) as rank,
    revenue / SUM(revenue) OVER () as pct_of_total
  FROM sales
`;

const runningTotal = await sql`
  SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date) as running_total
  FROM transactions
`;
```

## Common Table Expressions (CTEs)

Break complex queries into readable steps:

```typescript
const report = await sql`
  WITH daily_stats AS (
    SELECT
      DATE(created_at) as date,
      COUNT(*) as orders,
      SUM(total) as revenue
    FROM orders
    GROUP BY DATE(created_at)
  ),
  weekly_avg AS (
    SELECT
      date,
      orders,
      revenue,
      AVG(revenue) OVER (
        ORDER BY date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
      ) as rolling_avg
    FROM daily_stats
  )
  SELECT * FROM weekly_avg
  ORDER BY date DESC
  LIMIT 30
`;
```

## Date operations

```typescript
// Filter by date range
const thisMonth = await sql`
  SELECT * FROM orders
  WHERE created_at >= DATE_TRUNC('month', CURRENT_DATE)
`;

// Group by time period
const byMonth = await sql`
  SELECT
    DATE_TRUNC('month', created_at) as month,
    COUNT(*) as count
  FROM orders
  GROUP BY 1
  ORDER BY 1
`;

// Relative dates
const lastWeek = await sql`
  SELECT * FROM events
  WHERE created_at > NOW() - INTERVAL '7 days'
`;
```

## Full-text search

```typescript
const results = await sql`
  SELECT * FROM articles
  WHERE to_tsvector('english', title || ' ' || body)
     @@ plainto_tsquery('english', ${searchQuery})
  ORDER BY ts_rank(
    to_tsvector('english', title || ' ' || body),
    plainto_tsquery('english', ${searchQuery})
  ) DESC
`;
```

## JSON operations

```typescript
// Query JSON columns
const users = await sql`
  SELECT
    id,
    metadata->>'email' as email,
    metadata->'preferences'->>'theme' as theme
  FROM users
  WHERE metadata->>'role' = 'admin'
`;

// Aggregate to JSON
const grouped = await sql`
  SELECT
    department,
    JSON_AGG(name) as employees
  FROM employees
  GROUP BY department
`;
```

## Performance tips

### Use indexes

```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_user_date ON orders(user_id, created_at);
```

### Analyze query plans

```typescript
const plan = await sql`EXPLAIN ANALYZE SELECT * FROM large_table`;
console.log(plan);
```

### Limit result sets

```typescript
// For previews, always limit
const preview = await sql`
  SELECT * FROM big_table
  LIMIT 100
`;
```

## Next steps

- [Transform data](/data/transforming/) for cleaning and reshaping
- Build [Charts](/apps/charts/) from your queries
